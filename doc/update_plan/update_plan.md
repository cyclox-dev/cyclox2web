# PHP・CakePHPアップデート計画書

## 1. プロジェクト概要

### 現状分析
- **PHPバージョン**: 推定5.2.8～5.6.x（CakePHP 2.xの動作要件から推測）
- **フレームワーク**: CakePHP 2.10.24
- **主な懸念事項**:
  - PHP 5.xは2019年1月にサポート終了（セキュリティリスク）
  - CakePHP 2.xはサポート終了
  - 最新のライブラリやツールとの互換性問題
  - 将来的なメンテナンス困難

### 目標
- PHP 8.xへのアップグレード
- CakePHP 4.xへの移行
- コンテナ環境への移行
- セキュリティとパフォーマンスの向上

## 2. 移行戦略

### アップグレード順序
1. **PHP 5.x → PHP 7.4**（中間ステップとして）
2. **CakePHP 2.10.24 → CakePHP 3.9**
3. **PHP 7.4 → PHP 8.x**
4. **CakePHP 3.9 → CakePHP 4.x**

### 移行アプローチ
- **機能単位での垂直スライス方式**を採用
- 各機能グループを独立して移行
- 優先順位: 共通コンポーネント → 基本機能 → 複雑な機能

## 3. 実施計画

### フェーズ0: 開発環境のコンテナ化（0.5人月）
- **Dockerコンテナ環境の構築**
  - PHP 5.x環境のDockerイメージ作成
  - PHP 7.4環境のDockerイメージ作成
  - PHP 8.x環境のDockerイメージ作成
  - MySQLなど必要なサービスのコンテナ化
  - docker-compose.ymlの作成

- **開発ワークフロー整備**
  - ボリュームマウントの設定
  - ホットリロード環境の構築
  - デバッグ環境の整備（Xdebugなど）

- **CI/CDパイプラインの構築**
  - 自動テスト環境の整備
  - 複数PHP環境での並行テスト設定

### フェーズ1: 現状評価と準備（0.5人月）
- **詳細な依存関係の調査**
  - コンテナ環境を活用した互換性テスト
  - 使用しているすべてのライブラリとバージョンの特定
  - PHPの互換性問題の洗い出し

- **テスト環境の構築**
  - コンテナ化された現行システムの完全なコピーを作成
  - 自動テストの作成（可能であれば）
  - 手動テストシナリオの文書化

### フェーズ2: 機能グループごとの移行（8.0人月）

#### 共通コンポーネント（1.5人月）
- AppController/AppModelの移行
- プラグイン（Acl, DebugKit, Search, Utils）の移行
- ヘルパー関数の移行
- Cyclox/Util, Cyclox/Constの移行
- 設定ファイルの移行

#### 基本UI機能（1.0人月）
- 一覧画面（index）の移行
- 詳細画面（view）の移行
- 編集画面（edit）の移行
- 削除処理の移行
- レイアウト・テンプレートの移行

#### 選手管理機能（1.0人月）
- Racersコントローラーの移行
- Racerモデルの移行
- CategoryRacerモデルの移行
- 名寄せ機能の移行
- 関連ビューの移行

#### 大会管理機能（1.2人月）
- Meetsコントローラーの移行
- Meetモデルの移行
- MeetGroupsの移行
- EntryGroups/EntryCategoriesの移行
- 関連ビューの移行

#### カテゴリー管理機能（1.0人月）
- Categoriesコントローラーの移行
- Categoryモデルの移行
- CategoryGroupsの移行
- 昇格・降格処理の移行
- 関連ビューの移行

#### ポイント管理機能（1.3人月）
- PointSeriesコントローラーの移行
- PointSeriesモデルの移行
- PointSeriesGroupsの移行
- ランキング計算処理の移行
- 関連ビューの移行

#### API機能（1.0人月）
- ApiControllerの移行
- エントリーデータAPI処理の移行
- リザルトデータAPI処理の移行
- 選手データAPI処理の移行
- その他API処理の移行

#### バッチ処理機能（1.0人月）
- cronジョブの移行
- リザルト再計算処理の移行
- ランキング更新処理の移行
- カテゴリー制限処理の移行
- その他バッチ処理の移行

#### ユーティリティ機能（0.7人月）
- CSVデータ提供機能の移行
- エントリー＆リザルト読込機能の移行

#### ユーザー管理・権限管理機能（0.8人月）
- ユーザー登録・編集・削除機能の移行
- ログイン・ログアウト機能の移行
- 権限管理（ACL）機能の移行
- 認証・認可システムの移行

### フェーズ3: テストと最終調整（1.0人月）
- 総合テスト
- パフォーマンス最適化
- ドキュメント作成

### フェーズ4: 本番環境への展開（0.5人月）
- 本番環境のコンテナ化
- 段階的デプロイ

## 4. 各機能グループの移行ステップ

各機能グループは以下の順序で移行を進める：

1. **PHP 7.4互換性対応**
   - 非推奨関数の置き換え
   - 型宣言の導入
   - エラー処理の変更

2. **CakePHP 3.9への移行**
   - 名前空間の導入
   - コントローラー/モデル/ビューの構造変更
   - ルーティングの更新
   - ORM移行（Table、Entity）

3. **PHP 8.x互換性対応**
   - 新構文の活用
   - 非推奨機能の対応
   - 型システムの強化

4. **CakePHP 4.xへの移行**
   - ミドルウェアの活用
   - 依存性注入の導入
   - 認証・認可システムの更新

## 5. 技術的変更点の詳細

### PHP 5.x→7.4への主な変更点
- mysql_*関数からmysqli_*またはPDOへの移行
- 厳格な型チェックへの対応
- 可変変数・間接参照の構文変更
- エラー処理の例外ベースへの移行
- 型宣言（引数・戻り値）の導入

### CakePHP 2→3への主な変更点
- 名前空間の導入
- ディレクトリ構造の変更
- モデルからTableとEntityへの分離
- コントローラーの構造変更
- ビューテンプレートの変更（.ctpから.php）
- ヘルパーとコンポーネントの変更
- ORM（クエリビルダー）の変更
- ルーティングの変更

### PHP 7.4→8.xへの主な変更点
- コンストラクタプロパティプロモーションの活用
- match式の導入
- Nullsafe演算子（?->）の活用
- 名前付き引数の活用
- Union型の導入
- JITコンパイラの最適化

### CakePHP 3→4への主な変更点
- HTTPミドルウェアの導入
- 依存性注入コンテナの活用
- 認証・認可システムの変更
- イベントシステムの変更
- エラーハンドリングの変更
- デバッグツールの変更

## 6. コンテナ環境の構成

```yaml
# docker-compose.yml 概念図
version: '3'

services:
  # 現行環境（PHP 5.x + CakePHP 2.10.24）
  app-php5:
    build:
      context: ./docker/php5
    volumes:
      - ./:/var/www/html
    depends_on:
      - mysql

  # 中間環境（PHP 7.4 + CakePHP 3.9）
  app-php74:
    build:
      context: ./docker/php74
    volumes:
      - ./:/var/www/html
    depends_on:
      - mysql

  # 最終目標環境（PHP 8.x + CakePHP 4.x）
  app-php8:
    build:
      context: ./docker/php8
    volumes:
      - ./:/var/www/html
    depends_on:
      - mysql

  # Webサーバー
  nginx:
    image: nginx:alpine
    ports:
      - "8000:80"
    volumes:
      - ./:/var/www/html
      - ./docker/nginx:/etc/nginx/conf.d
    depends_on:
      - app-php5  # 切り替え可能

  # データベース
  mysql:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cyclox2
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  mysql_data:
```

## 7. 工数見積もり

| フェーズ | 工数 | 備考 |
|---------|------|------|
| フェーズ0: 開発環境のコンテナ化 | 0.5人月 | 初期準備 |
| フェーズ1: 現状評価と準備 | 0.5人月 | 分析フェーズ |
| フェーズ2: 機能グループごとの移行 | 9.5人月 | 実際の機能実装 |
| フェーズ3: テストと最終調整 | 1.0人月 | 品質保証 |
| フェーズ4: 本番環境への展開 | 0.5人月 | リリース |
| **合計** | **12.0人月** | |

### 工数計算の前提条件
- **1日あたりの稼働時間**: 8時間
- **月の稼働日数**: 20日（平日のみ）
- **稼働率**: 80%
- **1人月の実質稼働時間**: 128時間（8時間 × 20日 × 0.8）
- **AIエージェントのコーディングサポート**: 効率化率30%を見込む

上記の前提条件に基づき、12.0人月は約1,536時間（12.0人月 × 128時間）の作業時間に相当します。AIエージェントのサポートにより、通常より30%程度の効率化が見込まれるため、実質的な工数は約8.4人月程度と想定されます。

## 8. リスクと対策

### 主なリスク
1. **互換性の問題**
   - 対策: 段階的なアップグレードと徹底したテスト

2. **データモデルの複雑さ**
   - 対策: 慎重なORM移行と関連の再定義

3. **カスタム拡張の再実装**
   - 対策: Cyclox/UtilなどのカスタムクラスをCakePHP 3/4の新しいアーキテクチャに適応させる

4. **ダウンタイム**
   - 対策: ブルー/グリーンデプロイメント戦略の採用

### リスク軽減策
- 各機能グループでの徹底したテスト
- ロールバック計画の策定
- AIエージェントモードの活用による効率化
- 段階的な移行とリリース

## 9. AIエージェントモードの活用

AIエージェントモードは以下の作業で特に効果を発揮します：

1. **コード変換の自動化**
   - PHP 5→7→8の構文変更
   - CakePHP 2→3→4の移行パターン適用

2. **エラー解決の効率化**
   - 発生したエラーの原因特定と修正提案
   - 互換性問題の解決策提示

3. **ボイラープレートコードの生成**
   - 名前空間宣言
   - 型宣言の追加
   - 新しいクラス構造の生成

4. **複雑なロジックの移行支援**
   - ポイント計算ロジックの移行
   - カテゴリー昇格・降格ロジックの移行
   - API処理の移行

AIエージェントモードの活用により、通常より30%程度の効率化が見込まれます。

## 10. 成功基準

1. すべての機能がPHP 8.xとCakePHP 4.xで正常に動作する
2. セキュリティ脆弱性が解消される
3. パフォーマンスが現行システム以上になる
4. コンテナ環境で安定して動作する
5. 将来的な保守性が向上する

## 11. まとめ

本計画は、古いPHPバージョンとCakePHPフレームワークを使用したCyclox2webシステムを、最新の技術スタックに段階的に移行するための包括的なアプローチを提供します。コンテナ化と機能単位での垂直スライス方式を採用することで、リスクを最小限に抑えながら効率的に移行を進めることができます。

特に複雑なデータモデルを持つシステムであるため、ORM移行には十分な注意を払い、各機能グループごとに段階的に進めることで、安全な移行を実現します。AIエージェントモードの活用により、開発効率の向上も見込まれます。

総工数は約12.0人月と見積もられ、ベテランエンジニアとAIエージェントモードの組み合わせにより、効率的な実施が可能です。
