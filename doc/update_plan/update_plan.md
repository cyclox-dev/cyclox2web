# PHP・CodeIgniter4アップデート計画書

## 1. プロジェクト概要

### 現状分析
- **PHPバージョン**: 推定5.2.8～5.6.x（CakePHP 2.xの動作要件から推測）
- **フレームワーク**: CakePHP 2.10.24
- **主な懸念事項**:
  - PHP 5.xは2019年1月にサポート終了（セキュリティリスク）
  - CakePHP 2.xはサポート終了
  - 最新のライブラリやツールとの互換性問題
  - 将来的なメンテナンス困難

### 目標
- PHP 8.xへのアップグレード
- CakePHPからCodeIgniter4への移行
- コンテナ環境への移行
- セキュリティとパフォーマンスの向上
- 既存処理の変更なし
- データベーステーブル（データ構造）の変更なし

## 2. 移行戦略

### アップグレード順序
1. **新環境の構築**: PHP 8.x + CodeIgniter4の基盤を新たに構築
2. **共通コンポーネントの移行**: 共通機能を先行して移行
3. **機能単位での段階的移行**: 各機能グループを順次移行
4. **旧環境からの切り替え**: 移行完了後に本番環境を切り替え

※ 既存のPHP 5.x + CakePHP 2.10.24環境は移行完了まで並行稼働

### 移行アプローチ
- **基盤先行型**を採用
  - PHP 8.x + CodeIgniter4の基盤を先に構築
  - 共通コンポーネントを早期に移行し、実装パターンを確立
- **機能単位での垂直スライス方式**
  - 各機能グループを独立して移行
  - 優先順位: 共通コンポーネント → 基本機能 → 複雑な機能

## 3. 実施計画

### サマリ

| フェーズ | 工数 | 備考 |
|---------|------|------|
| フェーズ1: 要件定義とシステム構成設計 | 1.2人月 | 要件定義と環境設計 |
| フェーズ2: 開発環境のコンテナ化 | 0.5人月 | 初期準備 |
| フェーズ3: 現状評価と準備 | 0.8人月 | 分析フェーズ |
| フェーズ4: 基盤構築 | 2.5人月 | CodeIgniter4基盤 |
| フェーズ5: 共通コンポーネント移行 | 2.2人月 | 共通機能 |
| フェーズ6: 機能グループごとの移行 | 10.0人月 | 実際の機能実装 |
| フェーズ7: テストと最終調整 | 1.5人月 | 品質保証 |
| フェーズ8: 本番環境への展開 | 0.7人月 | リリース |
| **合計** | **19.4人月** | |

#### 工数計算の前提条件
- **1日あたりの稼働時間**: 8時間
- **月の稼働日数**: 20日（平日のみ）
- **稼働率**: 80%
- **1人月の実質稼働時間**: 128時間（8時間 × 20日 × 0.8）
- **AIエージェントのコーディングサポート**: 効率化率25%を見込む

上記の前提条件に基づき、19.4人月は約2,483時間（19.4人月 × 128時間）の作業時間に相当します。AIエージェントのサポートにより、通常より25%程度の効率化が見込まれるため、実質的な工数は約14.6人月程度と想定されます。

### フェーズ1: 要件定義とシステム構成設計（1.2人月）

#### 要件定義（0.4人月）
- **機能要件の定義**
  - 現行システムの機能一覧の作成と優先度付け
  - 移行後も維持すべき機能の特定
  - ユーザーインターフェース要件の定義
  - API要件の定義（外部連携を含む）
  - レポート・出力要件の定義

- **非機能要件の定義**
  - パフォーマンス要件（応答時間、スループット、同時接続数など）
  - 可用性要件（稼働率、メンテナンス時間など）
  - セキュリティ要件（認証、認可、暗号化、監査ログなど）
  - 拡張性要件（将来の機能追加、ユーザー増加への対応）
  - 運用保守要件（監視、バックアップ、障害復旧など）
  - コンプライアンス要件（法令遵守、個人情報保護など）

#### 現行システム分析（0.2人月）
- 現在のホスティングサービス利用状況の調査
- 現行システムのパフォーマンス特性と要件の分析
- 現行システムの依存関係とインフラ要件の特定

#### 新環境のアーキテクチャ設計（0.4人月）
- PHP 8.x + CodeIgniter4に最適化されたシステム構成の設計
- 開発環境、ステージング環境、本番環境の詳細設計
- スケーラビリティとパフォーマンス要件の定義
- セキュリティ設計（WAF、ネットワークセグメンテーションなど）

#### インフラストラクチャ計画（0.2人月）
- クラウドリソース要件の定義（サーバー、ストレージ、ネットワーク）
- コンテナ化戦略の策定
- CI/CDパイプラインの設計
- バックアップと災害復旧計画

### フェーズ2: 開発環境のコンテナ化（0.5人月）
- **Dockerコンテナ環境の構築**
  - PHP 5.x環境のDockerイメージ作成
  - PHP 7.4環境のDockerイメージ作成
  - PHP 8.x環境のDockerイメージ作成
  - MySQLなど必要なサービスのコンテナ化
  - docker-compose.ymlの作成

- **開発ワークフロー整備**
  - ボリュームマウントの設定
  - ホットリロード環境の構築
  - デバッグ環境の整備（Xdebugなど）

- **CI/CDパイプラインの構築**
  - 自動テスト環境の整備
  - 複数PHP環境での並行テスト設定

### フェーズ3: 現状評価と準備（0.8人月）
- **詳細な依存関係の調査**（0.4人月）
  - CakePHPの機能利用状況の詳細分析
  - CodeIgniter4での代替機能の特定
  - 使用しているすべてのライブラリとバージョンの特定
  - PHPの互換性問題の洗い出し

- **テスト環境の構築**（0.4人月）
  - コンテナ化された現行システムの完全なコピーを作成
  - 機能テストシナリオの文書化
  - 移行検証用のテスト環境構築

### フェーズ4: 基盤構築（2.5人月）
- **CodeIgniter4の基本構造構築**（0.5人月）
  - プロジェクト初期化
  - ディレクトリ構造の設定
  - 基本設定ファイルの作成

- **データベース接続設定**（0.3人月）
  - データベース接続の構成
  - モデル基盤の構築
  - マイグレーション機能の設定

- **認証・認可システムの構築**（0.5人月）
  - ユーザー認証システムの構築
  - 権限管理システムの構築
  - セッション管理の設定

- **共通ユーティリティの移行**（0.7人月）
  - Cyclox/Util, Cyclox/Constの移行
  - ヘルパー関数の移行
  - 共通ライブラリの移行

- **実装パターンの確立と文書化**（0.5人月）
  - コーディング規約の策定
  - 設計パターンの文書化
  - サンプル実装の作成

### フェーズ5: 共通コンポーネント移行（2.2人月）
- **AppController/AppModelの移行**（0.6人月）
  - 基底コントローラーの実装
  - 基底モデルの実装
  - 共通メソッドの移行

- **プラグイン機能の代替実装**（1.0人月）
  - Aclプラグイン相当機能の実装
  - DebugKit相当機能の実装
  - Search相当機能の実装
  - Utils相当機能の実装

- **設定ファイルの移行**（0.2人月）
  - アプリケーション設定の移行
  - 環境別設定の構成
  - 定数定義の移行

- **共通ヘルパーとライブラリの移行**（0.4人月）
  - フォームヘルパーの移行
  - HTMLヘルパーの移行
  - その他共通ライブラリの移行

### フェーズ6: 機能グループごとの移行（10.0人月）

#### 基本UI機能（1.3人月）
- 一覧画面（index）の移行（0.4人月）
- 詳細画面（view）の移行（0.3人月）
- 編集画面（edit）の移行（0.5人月）
- 削除処理の移行（0.2人月）
- レイアウト・テンプレートの移行（0.1人月）

#### 選手管理機能（1.3人月）
- Racersコントローラーの移行（0.4人月）
- Racerモデルの移行（0.5人月）
- CategoryRacerモデルの移行（0.3人月）
- 名寄せ機能の移行（0.2人月）
- 関連ビューの移行（0.1人月）

#### 大会管理機能（1.5人月）
- Meetsコントローラーの移行（0.4人月）
- Meetモデルの移行（0.5人月）
- MeetGroupsの移行（0.3人月）
- EntryGroups/EntryCategoriesの移行（0.4人月）
- 関連ビューの移行（0.1人月）

#### カテゴリー管理機能（1.3人月）
- Categoriesコントローラーの移行（0.3人月）
- Categoryモデルの移行（0.5人月）
- CategoryGroupsの移行（0.3人月）
- 昇格・降格処理の移行（0.3人月）
- 関連ビューの移行（0.1人月）

#### ポイント管理機能（1.6人月）
- PointSeriesコントローラーの移行（0.4人月）
- PointSeriesモデルの移行（0.5人月）
- PointSeriesGroupsの移行（0.3人月）
- ランキング計算処理の移行（0.5人月）
- 関連ビューの移行（0.1人月）

#### API機能（1.0人月）
- ApiControllerの移行（0.3人月）
- エントリーデータAPI処理の移行（0.3人月）
- リザルトデータAPI処理の移行（0.3人月）
- 選手データAPI処理の移行（0.2人月）
- その他API処理の移行（0.1人月）

#### バッチ処理機能（0.8人月）
- cronジョブの移行（0.2人月）
- リザルト再計算処理の移行（0.3人月）
- ランキング更新処理の移行（0.3人月）
- カテゴリー制限処理の移行（0.1人月）
- その他バッチ処理の移行（0.1人月）

#### ユーティリティ機能（0.7人月）
- CSVデータ提供機能の移行（0.3人月）
- エントリー＆リザルト読込機能の移行（0.5人月）

#### ユーザー管理・権限管理機能（1.0人月）
- ユーザー登録・編集・削除機能の移行（0.3人月）
- ログイン・ログアウト機能の移行（0.3人月）
- 権限管理機能の移行（0.4人月）
- 認証・認可システムの移行（0.2人月）

### フェーズ7: テストと最終調整（1.5人月）
- **総合テスト**（0.8人月）
  - 機能テスト
  - 統合テスト
  - パフォーマンステスト
  - セキュリティテスト

- **パフォーマンス最適化**（0.4人月）
  - ボトルネックの特定と解消
  - キャッシュ戦略の実装
  - データベースクエリの最適化

- **ドキュメント作成**（0.3人月）
  - 開発者向けドキュメント
  - 運用者向けドキュメント
  - APIドキュメント

### フェーズ8: 本番環境への展開（0.7人月）
- **本番環境のコンテナ化**（0.4人月）
  - 本番用Dockerイメージの作成
  - 本番環境の構成
  - 監視・ロギング設定

- **段階的デプロイ**（0.3人月）
  - デプロイ計画の策定
  - ブルー/グリーンデプロイメントの実施
  - 切り戻し計画の準備

## 4. CakePHPからCodeIgniter4への移行の主な変更点

### アーキテクチャの違い
- **MVC構造**: 両フレームワークともMVCを採用しているが、実装方法が異なる
- **名前空間**: CodeIgniter4は完全に名前空間ベース
- **設定**: 設定ファイルの構造と読み込み方法が異なる
- **ルーティング**: ルーティング定義の方法が異なる

### モデル層の違い
- **ORM**: CakePHPのORMとCodeIgniterのモデルシステムは設計思想が異なる
- **リレーション**: リレーションの定義方法が異なる
- **バリデーション**: バリデーションルールの定義方法が異なる

### コントローラー層の違い
- **基底クラス**: 継承構造が異なる
- **レスポンス生成**: レスポンス生成の仕組みが異なる
- **フィルター**: CodeIgniter4ではフィルターを使用

### ビュー層の違い
- **テンプレートエンジン**: テンプレート構文が異なる
- **ヘルパー**: 利用可能なヘルパー関数が異なる
- **レイアウト**: レイアウト管理の仕組みが異なる

### その他の違い
- **セッション管理**: セッション処理の実装が異なる
- **認証・認可**: 組み込みの認証システムが異なる
- **キャッシュ**: キャッシュ機能の実装が異なる
- **ロギング**: ログ機能の実装が異なる

## 5. PHP 5.x→8.xへの主な変更点

### PHP 5.x→7.4への主な変更点
- mysql_*関数からmysqli_*またはPDOへの移行
- 厳格な型チェックへの対応
- 可変変数・間接参照の構文変更
- エラー処理の例外ベースへの移行
- 型宣言（引数・戻り値）の導入

### PHP 7.4→8.xへの主な変更点
- コンストラクタプロパティプロモーションの活用
- match式の導入
- Nullsafe演算子（?->）の活用
- 名前付き引数の活用
- Union型の導入
- JITコンパイラの最適化

## 6. コンテナ環境の構成

```yaml
# docker-compose.yml 概念図
version: '3'

services:
  # 現行環境（PHP 5.x + CakePHP 2.10.24）
  app-php5:
    build:
      context: ./docker/php5
    volumes:
      - ./:/var/www/html
    depends_on:
      - mysql

  # 中間環境（PHP 7.4 + CakePHP 2.10.24）
  app-php74:
    build:
      context: ./docker/php74
    volumes:
      - ./:/var/www/html
    depends_on:
      - mysql

  # 最終目標環境（PHP 8.x + CodeIgniter4）
  app-php8:
    build:
      context: ./docker/php8
    volumes:
      - ./:/var/www/html
    depends_on:
      - mysql

  # Webサーバー
  nginx:
    image: nginx:alpine
    ports:
      - "8000:80"
    volumes:
      - ./:/var/www/html
      - ./docker/nginx:/etc/nginx/conf.d
    depends_on:
      - app-php5  # 切り替え可能

  # データベース
  mysql:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cyclox2
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  mysql_data:
```

## 7. リスクと対策

### 主なリスク
1. **フレームワーク間の互換性の問題**
   - 対策: 詳細な機能マッピングと徹底したテスト

2. **データモデルの複雑さ**
   - 対策: データベース構造を変更せず、モデル層のみを適切に移行

3. **カスタム拡張の再実装**
   - 対策: Cyclox/UtilなどのカスタムクラスをCodeIgniter4の設計パターンに適応させる

4. **ダウンタイム**
   - 対策: ブルー/グリーンデプロイメント戦略の採用

### リスク軽減策
- 各機能グループでの徹底したテスト
- ロールバック計画の策定
- AIエージェントモードの活用による効率化
- 段階的な移行とリリース

## 8. AIエージェントモードの活用

AIエージェントモードは以下の作業で特に効果を発揮します：

1. **コード変換の自動化**
   - PHP 5→7→8の構文変更
   - CakePHPからCodeIgniter4への移行パターン適用

2. **エラー解決の効率化**
   - 発生したエラーの原因特定と修正提案
   - 互換性問題の解決策提示

3. **ボイラープレートコードの生成**
   - 名前空間宣言
   - 型宣言の追加
   - 新しいクラス構造の生成

4. **複雑なロジックの移行支援**
   - ポイント計算ロジックの移行
   - カテゴリー昇格・降格ロジックの移行
   - API処理の移行

AIエージェントモードの活用により、通常より25%程度の効率化が見込まれます。

## 9. 成功基準

1. すべての機能がPHP 8.xとCodeIgniter4で正常に動作する
2. 既存の処理ロジックが変更されていない
3. データベース構造が維持されている
4. セキュリティ脆弱性が解消される
5. パフォーマンスが現行システム以上になる
6. コンテナ環境で安定して動作する
7. 将来的な保守性が向上する

## 10. まとめ

本計画は、古いPHPバージョンとCakePHPフレームワークを使用したCyclox2webシステムを、PHP 8.xとCodeIgniter4という最新の技術スタックに移行するための包括的なアプローチを提供します。

特に重要なのは、既存の処理ロジックを変更せず、データベース構造も維持したまま移行を行うという点です。これにより、ビジネスロジックの一貫性を保ちながら、技術的な基盤を刷新することが可能になります。

基盤先行型のアプローチを採用し、まずPHP 8.x + CodeIgniter4の基盤を構築し、共通コンポーネントを早期に移行することで、後続の機能移行を効率化します。また、機能単位での垂直スライス方式により、リスクを最小限に抑えながら段階的に移行を進めることができます。

総工数は約19.4人月と見積もられますが、AIエージェントのサポートにより、実質的な工数は約14.6人月程度と想定されます。ベテランエンジニアとAIエージェントモードの組み合わせにより、効率的な実施が可能です。
